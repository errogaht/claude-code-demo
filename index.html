<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏–º—É–ª—è—Ü–∏—è –∫–∞—Å–∫–∞–¥–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–≤—ã–º–∏ –∫–æ—Ç–ª–∞–º–∏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #4fc3f7;
            text-shadow: 0 0 10px rgba(79, 195, 247, 0.5);
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .schema-section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .control-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* –°—Ö–µ–º–∞ –∫–æ—Ç–µ–ª—å–Ω–æ–π */
        .boiler-house {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .steam-header {
            background: linear-gradient(90deg, #455a64, #607d8b, #455a64);
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: inset 0 -5px 15px rgba(0,0,0,0.3);
        }

        .steam-header-label {
            font-weight: bold;
            font-size: 14px;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .pressure-display {
            position: absolute;
            right: 20px;
            background: #000;
            padding: 8px 15px;
            border-radius: 8px;
            border: 2px solid #4fc3f7;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            color: #4fc3f7;
            text-shadow: 0 0 10px rgba(79, 195, 247, 0.8);
        }

        .boilers-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .boiler {
            background: linear-gradient(180deg, #37474f 0%, #263238 100%);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 2px solid #455a64;
            transition: all 0.3s ease;
            position: relative;
        }

        .boiler.running {
            border-color: #4caf50;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.4);
        }

        .boiler.master {
            border-color: #ff9800;
            box-shadow: 0 0 25px rgba(255, 152, 0, 0.5);
        }

        .boiler.fault {
            border-color: #f44336;
            box-shadow: 0 0 20px rgba(244, 67, 54, 0.5);
            animation: fault-blink 1s infinite;
        }

        .boiler.unavailable {
            opacity: 0.5;
        }

        @keyframes fault-blink {
            0%, 100% { border-color: #f44336; }
            50% { border-color: #ff8a80; }
        }

        .boiler-icon {
            width: 80px;
            height: 100px;
            margin: 0 auto 10px;
            background: linear-gradient(180deg, #546e7a 0%, #37474f 100%);
            border-radius: 10px 10px 5px 5px;
            position: relative;
            border: 2px solid #607d8b;
        }

        .boiler-icon::before {
            content: '';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 20px;
            background: #455a64;
            border-radius: 5px 5px 0 0;
        }

        .flame {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 30px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .boiler.running .flame {
            opacity: 1;
            animation: flame-flicker 0.5s infinite alternate;
        }

        @keyframes flame-flicker {
            0% { transform: translateX(-50%) scale(1); }
            100% { transform: translateX(-50%) scale(1.1); }
        }

        .flame-inner {
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at bottom, #ff9800 0%, #f44336 50%, transparent 70%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
        }

        .boiler-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .boiler-status {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-bottom: 8px;
        }

        .status-off { background: #616161; }
        .status-master { background: #ff9800; color: #000; }
        .status-reserve { background: #4caf50; }
        .status-fault { background: #f44336; }

        .boiler-power {
            font-family: 'Courier New', monospace;
            font-size: 20px;
            color: #4fc3f7;
            margin: 5px 0;
        }

        .boiler-mode {
            font-size: 10px;
            color: #9e9e9e;
        }

        .pipe {
            width: 8px;
            height: 40px;
            background: linear-gradient(90deg, #455a64, #607d8b, #455a64);
            margin: 0 auto;
            position: relative;
        }

        .pipe.active::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: steam-flow 1s infinite linear;
        }

        @keyframes steam-flow {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .panel-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .panel-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .panel-title {
            font-size: 14px;
            font-weight: bold;
            color: #4fc3f7;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.2s;
            width: 100%;
            margin-bottom: 8px;
        }

        .btn-start {
            background: linear-gradient(180deg, #4caf50, #388e3c);
            color: white;
        }

        .btn-start:hover {
            background: linear-gradient(180deg, #66bb6a, #43a047);
            transform: translateY(-2px);
        }

        .btn-stop {
            background: linear-gradient(180deg, #f44336, #c62828);
            color: white;
        }

        .btn-stop:hover {
            background: linear-gradient(180deg, #ef5350, #e53935);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .priority-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .priority-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0,0,0,0.2);
            padding: 8px 10px;
            border-radius: 6px;
        }

        .priority-item label {
            font-size: 12px;
        }

        .priority-item select {
            width: 50px;
            padding: 4px;
            border-radius: 4px;
            border: 1px solid #455a64;
            background: #263238;
            color: #fff;
        }

        .param-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .param-row label {
            font-size: 11px;
            flex: 1;
        }

        .param-row input {
            width: 70px;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #455a64;
            background: #263238;
            color: #4fc3f7;
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .param-row .unit {
            font-size: 10px;
            color: #9e9e9e;
            width: 40px;
            text-align: right;
        }

        /* –°–∏–º—É–ª—è—Ü–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ */
        .load-control {
            margin-top: 10px;
        }

        .load-slider {
            width: 100%;
            margin: 10px 0;
            -webkit-appearance: none;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, #4caf50, #ff9800, #f44336);
        }

        .load-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .load-display {
            text-align: center;
            font-size: 24px;
            font-family: 'Courier New', monospace;
            color: #ff9800;
        }

        /* –õ–æ–≥ —Å–æ–±—ã—Ç–∏–π */
        .log-section {
            margin-top: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .log-title {
            font-size: 14px;
            font-weight: bold;
            color: #4fc3f7;
            margin-bottom: 10px;
        }

        .log-container {
            height: 150px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            background: #000;
            padding: 10px;
            border-radius: 8px;
        }

        .log-entry {
            margin-bottom: 3px;
            padding: 2px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .log-time {
            color: #9e9e9e;
        }

        .log-info { color: #4fc3f7; }
        .log-success { color: #4caf50; }
        .log-warning { color: #ff9800; }
        .log-error { color: #f44336; }

        /* –°—Ç–∞—Ç—É—Å –±–∞—Ä */
        .status-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .status-card {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }

        .status-card-value {
            font-size: 24px;
            font-family: 'Courier New', monospace;
            color: #4fc3f7;
        }

        .status-card-label {
            font-size: 10px;
            color: #9e9e9e;
            margin-top: 5px;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ */
        .stabilization-indicator {
            background: #ff9800;
            color: #000;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            margin-top: 10px;
            display: none;
        }

        .stabilization-indicator.active {
            display: block;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* –ß–µ–∫–±–æ–∫—Å—ã –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ —Å–±–æ–µ–≤ */
        .fault-toggles {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }

        .fault-toggle {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            cursor: pointer;
        }

        .fault-toggle input {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>–ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–≤—ã–º–∏ –∫–æ—Ç–ª–∞–º–∏</h1>

        <div class="main-layout">
            <div class="schema-section">
                <div class="boiler-house">
                    <!-- –û–±—â–∏–π –ø–∞—Ä–æ–ø—Ä–æ–≤–æ–¥ -->
                    <div class="steam-header">
                        <span class="steam-header-label">–û–ë–©–ò–ô –ü–ê–†–û–ü–†–û–í–û–î</span>
                        <div class="pressure-display">
                            <span id="pressure-value">0.00</span> –ú–ü–∞
                        </div>
                    </div>

                    <!-- –¢—Ä—É–±—ã –æ—Ç –∫–æ—Ç–ª–æ–≤ -->
                    <div class="boilers-row">
                        <div class="pipe" id="pipe-0"></div>
                        <div class="pipe" id="pipe-1"></div>
                        <div class="pipe" id="pipe-2"></div>
                        <div class="pipe" id="pipe-3"></div>
                    </div>

                    <!-- –ö–æ—Ç–ª—ã -->
                    <div class="boilers-row">
                        <div class="boiler" id="boiler-0">
                            <div class="boiler-icon">
                                <div class="flame"><div class="flame-inner"></div></div>
                            </div>
                            <div class="boiler-name">–ö–æ—Ç—ë–ª ‚Ññ1</div>
                            <div class="boiler-status status-off" id="status-0">–û–¢–ö–õ</div>
                            <div class="boiler-power"><span id="power-0">0.0</span> –ú–í—Ç</div>
                            <div class="boiler-mode" id="mode-0">‚Äî</div>
                        </div>
                        <div class="boiler" id="boiler-1">
                            <div class="boiler-icon">
                                <div class="flame"><div class="flame-inner"></div></div>
                            </div>
                            <div class="boiler-name">–ö–æ—Ç—ë–ª ‚Ññ2</div>
                            <div class="boiler-status status-off" id="status-1">–û–¢–ö–õ</div>
                            <div class="boiler-power"><span id="power-1">0.0</span> –ú–í—Ç</div>
                            <div class="boiler-mode" id="mode-1">‚Äî</div>
                        </div>
                        <div class="boiler" id="boiler-2">
                            <div class="boiler-icon">
                                <div class="flame"><div class="flame-inner"></div></div>
                            </div>
                            <div class="boiler-name">–ö–æ—Ç—ë–ª ‚Ññ3</div>
                            <div class="boiler-status status-off" id="status-2">–û–¢–ö–õ</div>
                            <div class="boiler-power"><span id="power-2">0.0</span> –ú–í—Ç</div>
                            <div class="boiler-mode" id="mode-2">‚Äî</div>
                        </div>
                        <div class="boiler" id="boiler-3">
                            <div class="boiler-icon">
                                <div class="flame"><div class="flame-inner"></div></div>
                            </div>
                            <div class="boiler-name">–ö–æ—Ç—ë–ª ‚Ññ4</div>
                            <div class="boiler-status status-off" id="status-3">–û–¢–ö–õ</div>
                            <div class="boiler-power"><span id="power-3">0.0</span> –ú–í—Ç</div>
                            <div class="boiler-mode" id="mode-3">‚Äî</div>
                        </div>
                    </div>

                    <!-- –°—Ç–∞—Ç—É—Å –±–∞—Ä -->
                    <div class="status-bar">
                        <div class="status-card">
                            <div class="status-card-value" id="total-power">0.0</div>
                            <div class="status-card-label">–°—É–º–º–∞—Ä–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å, –ú–í—Ç</div>
                        </div>
                        <div class="status-card">
                            <div class="status-card-value" id="active-count">0</div>
                            <div class="status-card-label">–†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ç–ª–æ–≤</div>
                        </div>
                        <div class="status-card">
                            <div class="status-card-value" id="available-count">4</div>
                            <div class="status-card-label">–î–æ—Å—Ç—É–ø–Ω–æ –∫–æ—Ç–ª–æ–≤</div>
                        </div>
                        <div class="status-card">
                            <div class="status-card-value" id="master-num">‚Äî</div>
                            <div class="status-card-label">–û—Å–Ω–æ–≤–Ω–æ–π –∫–æ—Ç—ë–ª</div>
                        </div>
                    </div>

                    <div class="stabilization-indicator" id="stabilization">
                        ‚è≥ –°–¢–ê–ë–ò–õ–ò–ó–ê–¶–ò–Ø: <span id="stabilization-time">0</span> —Å–µ–∫
                    </div>
                </div>

                <!-- –õ–æ–≥ —Å–æ–±—ã—Ç–∏–π -->
                <div class="log-section">
                    <div class="log-title">üìã –ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π</div>
                    <div class="log-container" id="log"></div>
                </div>
            </div>

            <div class="control-panel">
                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Å–∫–∞–¥–æ–º -->
                <div class="panel-section">
                    <div class="panel-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Å–∫–∞–¥–æ–º</div>
                    <button class="btn btn-start" id="btn-start">‚ñ∂ –í–ö–õ–Æ–ß–ò–¢–¨ –ö–ê–°–ö–ê–î</button>
                    <button class="btn btn-stop" id="btn-stop" disabled>‚ñ† –û–¢–ö–õ–Æ–ß–ò–¢–¨ –ö–ê–°–ö–ê–î</button>
                </div>

                <!-- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã -->
                <div class="panel-section">
                    <div class="panel-title">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∫–æ—Ç–ª–æ–≤</div>
                    <div class="priority-grid">
                        <div class="priority-item">
                            <label>–ö–æ—Ç—ë–ª 1</label>
                            <select id="priority-0">
                                <option value="0">0</option>
                                <option value="1" selected>1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                        </div>
                        <div class="priority-item">
                            <label>–ö–æ—Ç—ë–ª 2</label>
                            <select id="priority-1">
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2" selected>2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                        </div>
                        <div class="priority-item">
                            <label>–ö–æ—Ç—ë–ª 3</label>
                            <select id="priority-2">
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3" selected>3</option>
                                <option value="4">4</option>
                            </select>
                        </div>
                        <div class="priority-item">
                            <label>–ö–æ—Ç—ë–ª 4</label>
                            <select id="priority-3">
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4" selected>4</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- –°–∏–º—É–ª—è—Ü–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ -->
                <div class="panel-section">
                    <div class="panel-title">–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –ø–∞—Ä–µ</div>
                    <div class="load-display"><span id="load-value">4.0</span> –ú–í—Ç</div>
                    <input type="range" class="load-slider" id="load-slider" min="0" max="16" step="0.5" value="4">
                    <div style="display: flex; justify-content: space-between; font-size: 10px; color: #9e9e9e;">
                        <span>0 –ú–í—Ç</span>
                        <span>16 –ú–í—Ç</span>
                    </div>
                </div>

                <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã -->
                <div class="panel-section">
                    <div class="panel-title">–£—Å—Ç–∞–≤–∫–∏</div>
                    <div class="param-row">
                        <label>–î–∞–≤–ª–µ–Ω–∏–µ:</label>
                        <input type="number" id="param-pressure" value="0.8" step="0.1" min="0.1" max="2">
                        <span class="unit">–ú–ü–∞</span>
                    </div>
                    <div class="param-row">
                        <label>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏:</label>
                        <input type="number" id="param-connect" value="3.5" step="0.1" min="1" max="4">
                        <span class="unit">–ú–í—Ç</span>
                    </div>
                    <div class="param-row">
                        <label>–û—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏:</label>
                        <input type="number" id="param-disconnect" value="1.5" step="0.1" min="1" max="4">
                        <span class="unit">–ú–í—Ç</span>
                    </div>
                    <div class="param-row">
                        <label>–ó–∞–¥–µ—Ä–∂–∫–∞ –≤–∫–ª/–æ—Ç–∫–ª:</label>
                        <input type="number" id="param-delay" value="5" step="1" min="1" max="60">
                        <span class="unit">—Å–µ–∫</span>
                    </div>
                    <div class="param-row">
                        <label>–°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è:</label>
                        <input type="number" id="param-stabilization" value="10" step="1" min="1" max="120">
                        <span class="unit">—Å–µ–∫</span>
                    </div>
                    <div class="param-row">
                        <label>–ú–æ—â–Ω–æ—Å—Ç—å —Ä–µ–∑–µ—Ä–≤–∞:</label>
                        <input type="number" id="param-reserve-power" value="2.5" step="0.1" min="1" max="4">
                        <span class="unit">–ú–í—Ç</span>
                    </div>
                </div>

                <!-- –°–∏–º—É–ª—è—Ü–∏—è —Å–±–æ–µ–≤ -->
                <div class="panel-section">
                    <div class="panel-title">–°–∏–º—É–ª—è—Ü–∏—è —Å–±–æ–µ–≤</div>
                    <div class="fault-toggles">
                        <label class="fault-toggle">
                            <input type="checkbox" id="fault-0"> –ê–≤–∞—Ä–∏—è –ö1
                        </label>
                        <label class="fault-toggle">
                            <input type="checkbox" id="fault-1"> –ê–≤–∞—Ä–∏—è –ö2
                        </label>
                        <label class="fault-toggle">
                            <input type="checkbox" id="fault-2"> –ê–≤–∞—Ä–∏—è –ö3
                        </label>
                        <label class="fault-toggle">
                            <input type="checkbox" id="fault-3"> –ê–≤–∞—Ä–∏—è –ö4
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== –°–û–°–¢–û–Ø–ù–ò–ï –°–ò–°–¢–ï–ú–´ =====
        const state = {
            cascadeEnabled: false,
            stabilizationLock: false,
            stabilizationTimer: 0,
            connectTimer: 0,
            disconnectTimer: 0,

            // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
            params: {
                pressureSetpoint: 0.8,
                powerConnectThreshold: 3.5,
                powerDisconnectThreshold: 1.5,
                connectDelay: 5,
                disconnectDelay: 5,
                stabilizationTime: 10,
                reservePowerSetpoint: 2.5,
                rampRate: 0.5  // –ú–í—Ç/—Å–µ–∫
            },

            // –ù–∞–≥—Ä—É–∑–∫–∞ (–ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –ø–∞—Ä–µ)
            steamDemand: 4.0,

            // –î–∞–≤–ª–µ–Ω–∏–µ –≤ –ø–∞—Ä–æ–ø—Ä–æ–≤–æ–¥–µ
            pressure: 0.0,

            // –ö–æ—Ç–ª—ã
            boilers: [
                { priority: 1, available: true, running: false, isMaster: false, isReserve: false, power: 0, powerSetpoint: 0, fault: false },
                { priority: 2, available: true, running: false, isMaster: false, isReserve: false, power: 0, powerSetpoint: 0, fault: false },
                { priority: 3, available: true, running: false, isMaster: false, isReserve: false, power: 0, powerSetpoint: 0, fault: false },
                { priority: 4, available: true, running: false, isMaster: false, isReserve: false, power: 0, powerSetpoint: 0, fault: false }
            ]
        };

        // ===== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï =====
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log');
            const time = new Date().toLocaleTimeString('ru-RU');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            logContainer.insertBefore(entry, logContainer.firstChild);

            // –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
            while (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // ===== –ü–û–ò–°–ö –ö–û–¢–õ–û–í =====
        function findHighestPriorityAvailable() {
            let best = -1;
            let bestPriority = 5;
            for (let i = 0; i < 4; i++) {
                const b = state.boilers[i];
                if (b.available && !b.running && b.priority > 0 && b.priority < bestPriority) {
                    bestPriority = b.priority;
                    best = i;
                }
            }
            return best;
        }

        function findLowestPriorityRunningReserve() {
            let worst = -1;
            let worstPriority = 0;
            for (let i = 0; i < 4; i++) {
                const b = state.boilers[i];
                if (b.isReserve && b.running && b.priority > worstPriority) {
                    worstPriority = b.priority;
                    worst = i;
                }
            }
            return worst;
        }

        function getMasterBoiler() {
            for (let i = 0; i < 4; i++) {
                if (state.boilers[i].isMaster && state.boilers[i].running) {
                    return i;
                }
            }
            return -1;
        }

        // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–¢–õ–ê–ú–ò =====
        function startBoilerAsMaster(index) {
            const b = state.boilers[index];
            b.running = true;
            b.isMaster = true;
            b.isReserve = false;
            b.powerSetpoint = 0;
            log(`–ö–æ—Ç—ë–ª ‚Ññ${index + 1} –∑–∞–ø—É—â–µ–Ω –∫–∞–∫ –û–°–ù–û–í–ù–û–ô (—Ä–µ–∂–∏–º –¥–∞–≤–ª–µ–Ω–∏—è)`, 'success');
        }

        function startBoilerAsReserve(index) {
            const b = state.boilers[index];
            b.running = true;
            b.isMaster = false;
            b.isReserve = true;
            b.powerSetpoint = state.params.reservePowerSetpoint;
            log(`–ö–æ—Ç—ë–ª ‚Ññ${index + 1} –∑–∞–ø—É—â–µ–Ω –∫–∞–∫ –†–ï–ó–ï–†–í–ù–´–ô (—É—Å—Ç–∞–≤–∫–∞ ${state.params.reservePowerSetpoint} –ú–í—Ç)`, 'success');
            startStabilization();
        }

        function stopBoiler(index) {
            const b = state.boilers[index];
            b.running = false;
            b.isMaster = false;
            b.isReserve = false;
            b.power = 0;
            b.powerSetpoint = 0;
            log(`–ö–æ—Ç—ë–ª ‚Ññ${index + 1} –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω`, 'warning');
        }

        function startStabilization() {
            state.stabilizationLock = true;
            state.stabilizationTimer = state.params.stabilizationTime;
            log(`–ù–∞—á–∞–ª–æ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ (${state.params.stabilizationTime} —Å–µ–∫)`, 'info');
        }

        // ===== –í–ö–õ–Æ–ß–ï–ù–ò–ï/–û–¢–ö–õ–Æ–ß–ï–ù–ò–ï –ö–ê–°–ö–ê–î–ê =====
        function enableCascade() {
            if (state.cascadeEnabled) return;

            const available = state.boilers.filter(b => b.available && b.priority > 0).length;
            if (available === 0) {
                log('–û–®–ò–ë–ö–ê: –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ—Ç–ª–æ–≤!', 'error');
                return;
            }

            state.cascadeEnabled = true;
            log('‚ïê‚ïê‚ïê –ö–ê–°–ö–ê–î–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï –í–ö–õ–Æ–ß–ï–ù–û ‚ïê‚ïê‚ïê', 'success');

            // –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ—Ç–ª–∞
            const masterIdx = findHighestPriorityAvailable();
            if (masterIdx >= 0) {
                startBoilerAsMaster(masterIdx);
            }

            updateButtons();
        }

        function disableCascade() {
            if (!state.cascadeEnabled) return;

            state.cascadeEnabled = false;
            state.stabilizationLock = false;
            state.connectTimer = 0;
            state.disconnectTimer = 0;

            // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∫–æ—Ç–ª—ã
            for (let i = 0; i < 4; i++) {
                if (state.boilers[i].running) {
                    stopBoiler(i);
                }
            }

            log('‚ïê‚ïê‚ïê –ö–ê–°–ö–ê–î–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï –û–¢–ö–õ–Æ–ß–ï–ù–û ‚ïê‚ïê‚ïê', 'warning');
            updateButtons();
        }

        // ===== –û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ –°–ò–ú–£–õ–Ø–¶–ò–ò =====
        function simulationTick(dt) {
            if (!state.cascadeEnabled) {
                // –î–∞–≤–ª–µ–Ω–∏–µ –ø–∞–¥–∞–µ—Ç –±–µ–∑ –∫–æ—Ç–ª–æ–≤
                state.pressure = Math.max(0, state.pressure - 0.05 * dt);
                return;
            }

            // –û–±–Ω–æ–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–æ—Ç–ª–æ–≤
            for (let i = 0; i < 4; i++) {
                const b = state.boilers[i];
                b.available = !b.fault && b.priority > 0;

                // –ï—Å–ª–∏ —Ä–∞–±–æ—Ç–∞—é—â–∏–π –∫–æ—Ç–µ–ª —Å—Ç–∞–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                if (b.running && !b.available) {
                    log(`–ê–í–ê–†–ò–Ø: –ö–æ—Ç—ë–ª ‚Ññ${i + 1} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!`, 'error');
                    b.priority = 0;  // –°–±—Ä–æ—Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
                    document.getElementById(`priority-${i}`).value = '0';

                    if (b.isMaster) {
                        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥–æ–π –∫–æ—Ç–µ–ª
                        stopBoiler(i);
                        const newMaster = findHighestPriorityAvailable();
                        if (newMaster >= 0) {
                            // –ï—Å–ª–∏ –±—ã–ª —Ä–µ–∑–µ—Ä–≤–Ω—ã–π - –ø–æ–≤—ã—Å–∏—Ç—å –¥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ
                            if (state.boilers[newMaster].isReserve) {
                                state.boilers[newMaster].isReserve = false;
                            }
                            startBoilerAsMaster(newMaster);
                        } else {
                            log('–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ—Ç–ª–æ–≤!', 'error');
                            disableCascade();
                            return;
                        }
                    } else {
                        stopBoiler(i);
                    }
                    startStabilization();
                }
            }

            // –ü–æ–ª—É—á–∏—Ç—å –∏–Ω–¥–µ–∫—Å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ—Ç–ª–∞
            const masterIdx = getMasterBoiler();
            if (masterIdx < 0) return;

            const master = state.boilers[masterIdx];

            // –†–∞—Å—á–µ—Ç —Ç—Ä–µ–±—É–µ–º–æ–π –º–æ—â–Ω–æ—Å—Ç–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ—Ç–ª–∞
            // –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ—Ç–µ–ª –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É –Ω–∞–≥—Ä—É–∑–∫–æ–π –∏ –º–æ—â–Ω–æ—Å—Ç—å—é —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö
            let reservePower = 0;
            for (let i = 0; i < 4; i++) {
                if (state.boilers[i].isReserve && state.boilers[i].running) {
                    reservePower += state.boilers[i].power;
                }
            }

            // –ú–æ—â–Ω–æ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ = –Ω–∞–≥—Ä—É–∑–∫–∞ - –º–æ—â–Ω–æ—Å—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö
            // –Ω–æ —Å —É—á–µ—Ç–æ–º –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –¥–∞–≤–ª–µ–Ω–∏—è
            const pressureError = state.params.pressureSetpoint - state.pressure;
            const masterRequired = Math.max(1, Math.min(4, state.steamDemand - reservePower + pressureError * 5));

            // –ü–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –º–æ—â–Ω–æ—Å—Ç–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ
            if (master.power < masterRequired) {
                master.power = Math.min(4, master.power + 2 * dt);
            } else {
                master.power = Math.max(1, master.power - 2 * dt);
            }

            // Ramping –º–æ—â–Ω–æ—Å—Ç–∏ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ—Ç–ª–æ–≤
            for (let i = 0; i < 4; i++) {
                const b = state.boilers[i];
                if (b.isReserve && b.running) {
                    if (b.power < b.powerSetpoint) {
                        b.power = Math.min(b.powerSetpoint, b.power + state.params.rampRate * dt);
                    }
                }
            }

            // –†–∞—Å—á–µ—Ç –¥–∞–≤–ª–µ–Ω–∏—è
            const totalPower = state.boilers.reduce((sum, b) => sum + (b.running ? b.power : 0), 0);
            const pressureDelta = (totalPower - state.steamDemand) * 0.02;
            state.pressure = Math.max(0, Math.min(1.5, state.pressure + pressureDelta * dt));

            // –õ–æ–≥–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö (–µ—Å–ª–∏ –Ω–µ—Ç —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏)
            if (!state.stabilizationLock) {
                // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ
                if (master.power >= state.params.powerConnectThreshold) {
                    state.connectTimer += dt;
                    if (state.connectTimer >= state.params.connectDelay) {
                        const nextReserve = findHighestPriorityAvailable();
                        if (nextReserve >= 0) {
                            startBoilerAsReserve(nextReserve);
                        }
                        state.connectTimer = 0;
                    }
                } else {
                    state.connectTimer = 0;
                }

                // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ
                const hasRunningReserves = state.boilers.some(b => b.isReserve && b.running);
                if (master.power <= state.params.powerDisconnectThreshold && hasRunningReserves) {
                    state.disconnectTimer += dt;
                    if (state.disconnectTimer >= state.params.disconnectDelay) {
                        const reserveToStop = findLowestPriorityRunningReserve();
                        if (reserveToStop >= 0) {
                            stopBoiler(reserveToStop);
                            startStabilization();
                        }
                        state.disconnectTimer = 0;
                    }
                } else {
                    state.disconnectTimer = 0;
                }
            }

            // –¢–∞–π–º–µ—Ä —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
            if (state.stabilizationLock) {
                state.stabilizationTimer -= dt;
                if (state.stabilizationTimer <= 0) {
                    state.stabilizationLock = false;
                    state.stabilizationTimer = 0;
                    log('–°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'info');
                }
            }
        }

        // ===== –û–ë–ù–û–í–õ–ï–ù–ò–ï UI =====
        function updateUI() {
            // –î–∞–≤–ª–µ–Ω–∏–µ
            document.getElementById('pressure-value').textContent = state.pressure.toFixed(2);

            // –ö–æ—Ç–ª—ã
            let totalPower = 0;
            let activeCount = 0;
            let availableCount = 0;
            let masterNum = '‚Äî';

            for (let i = 0; i < 4; i++) {
                const b = state.boilers[i];
                const boilerEl = document.getElementById(`boiler-${i}`);
                const statusEl = document.getElementById(`status-${i}`);
                const powerEl = document.getElementById(`power-${i}`);
                const modeEl = document.getElementById(`mode-${i}`);
                const pipeEl = document.getElementById(`pipe-${i}`);

                // –ö–ª–∞—Å—Å—ã –∫–æ—Ç–ª–∞
                boilerEl.className = 'boiler';
                if (b.fault) {
                    boilerEl.classList.add('fault');
                } else if (!b.available) {
                    boilerEl.classList.add('unavailable');
                } else if (b.isMaster && b.running) {
                    boilerEl.classList.add('running', 'master');
                } else if (b.running) {
                    boilerEl.classList.add('running');
                }

                // –°—Ç–∞—Ç—É—Å
                if (b.fault) {
                    statusEl.textContent = '–ê–í–ê–†–ò–Ø';
                    statusEl.className = 'boiler-status status-fault';
                } else if (b.isMaster && b.running) {
                    statusEl.textContent = '–û–°–ù–û–í–ù–û–ô';
                    statusEl.className = 'boiler-status status-master';
                    masterNum = `‚Ññ${i + 1}`;
                } else if (b.isReserve && b.running) {
                    statusEl.textContent = '–†–ï–ó–ï–†–í–ù–´–ô';
                    statusEl.className = 'boiler-status status-reserve';
                } else {
                    statusEl.textContent = '–û–¢–ö–õ';
                    statusEl.className = 'boiler-status status-off';
                }

                // –ú–æ—â–Ω–æ—Å—Ç—å
                powerEl.textContent = b.power.toFixed(1);

                // –†–µ–∂–∏–º
                if (b.isMaster && b.running) {
                    modeEl.textContent = `–†–µ–∂–∏–º –¥–∞–≤–ª–µ–Ω–∏—è (${state.params.pressureSetpoint} –ú–ü–∞)`;
                } else if (b.isReserve && b.running) {
                    modeEl.textContent = `–†–µ–∂–∏–º –º–æ—â–Ω–æ—Å—Ç–∏ (‚Üí${b.powerSetpoint.toFixed(1)} –ú–í—Ç)`;
                } else {
                    modeEl.textContent = '‚Äî';
                }

                // –¢—Ä—É–±–∞
                pipeEl.className = b.running ? 'pipe active' : 'pipe';

                // –ü–æ–¥—Å—á–µ—Ç
                if (b.running) {
                    totalPower += b.power;
                    activeCount++;
                }
                if (b.available) {
                    availableCount++;
                }
            }

            // –°—Ç–∞—Ç—É—Å –±–∞—Ä
            document.getElementById('total-power').textContent = totalPower.toFixed(1);
            document.getElementById('active-count').textContent = activeCount;
            document.getElementById('available-count').textContent = availableCount;
            document.getElementById('master-num').textContent = masterNum;

            // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
            const stabEl = document.getElementById('stabilization');
            if (state.stabilizationLock) {
                stabEl.classList.add('active');
                document.getElementById('stabilization-time').textContent = Math.ceil(state.stabilizationTimer);
            } else {
                stabEl.classList.remove('active');
            }
        }

        function updateButtons() {
            document.getElementById('btn-start').disabled = state.cascadeEnabled;
            document.getElementById('btn-stop').disabled = !state.cascadeEnabled;
        }

        // ===== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô =====
        document.getElementById('btn-start').addEventListener('click', enableCascade);
        document.getElementById('btn-stop').addEventListener('click', disableCascade);

        // –°–ª–∞–π–¥–µ—Ä –Ω–∞–≥—Ä—É–∑–∫–∏
        document.getElementById('load-slider').addEventListener('input', (e) => {
            state.steamDemand = parseFloat(e.target.value);
            document.getElementById('load-value').textContent = state.steamDemand.toFixed(1);
        });

        // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
        for (let i = 0; i < 4; i++) {
            document.getElementById(`priority-${i}`).addEventListener('change', (e) => {
                state.boilers[i].priority = parseInt(e.target.value);
                state.boilers[i].available = !state.boilers[i].fault && state.boilers[i].priority > 0;
                log(`–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∫–æ—Ç–ª–∞ ‚Ññ${i + 1} –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ ${e.target.value}`, 'info');
            });
        }

        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
        document.getElementById('param-pressure').addEventListener('change', (e) => {
            state.params.pressureSetpoint = parseFloat(e.target.value);
        });
        document.getElementById('param-connect').addEventListener('change', (e) => {
            state.params.powerConnectThreshold = parseFloat(e.target.value);
        });
        document.getElementById('param-disconnect').addEventListener('change', (e) => {
            state.params.powerDisconnectThreshold = parseFloat(e.target.value);
        });
        document.getElementById('param-delay').addEventListener('change', (e) => {
            state.params.connectDelay = parseInt(e.target.value);
            state.params.disconnectDelay = parseInt(e.target.value);
        });
        document.getElementById('param-stabilization').addEventListener('change', (e) => {
            state.params.stabilizationTime = parseInt(e.target.value);
        });
        document.getElementById('param-reserve-power').addEventListener('change', (e) => {
            state.params.reservePowerSetpoint = parseFloat(e.target.value);
        });

        // –°–∏–º—É–ª—è—Ü–∏—è —Å–±–æ–µ–≤
        for (let i = 0; i < 4; i++) {
            document.getElementById(`fault-${i}`).addEventListener('change', (e) => {
                state.boilers[i].fault = e.target.checked;
                if (e.target.checked) {
                    log(`–°–ò–ú–£–õ–Ø–¶–ò–Ø: –ê–≤–∞—Ä–∏—è –∫–æ—Ç–ª–∞ ‚Ññ${i + 1}`, 'error');
                } else {
                    log(`–°–ò–ú–£–õ–Ø–¶–ò–Ø: –ê–≤–∞—Ä–∏—è –∫–æ—Ç–ª–∞ ‚Ññ${i + 1} —Å–Ω—è—Ç–∞`, 'info');
                }
            });
        }

        // ===== –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ =====
        let lastTime = Date.now();

        function mainLoop() {
            const now = Date.now();
            const dt = (now - lastTime) / 1000;  // –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            lastTime = now;

            simulationTick(dt);
            updateUI();

            requestAnimationFrame(mainLoop);
        }

        // –ó–∞–ø—É—Å–∫
        log('–°–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞', 'info');
        log('–ù–∞–∂–º–∏—Ç–µ "–í–ö–õ–Æ–ß–ò–¢–¨ –ö–ê–°–ö–ê–î" –¥–ª—è –∑–∞–ø—É—Å–∫–∞', 'info');
        mainLoop();
    </script>
</body>
</html>
